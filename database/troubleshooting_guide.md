# دليل استكشاف الأخطاء وإصلاحها - تطبيق حقوقي

## أخطاء قاعدة البيانات الشائعة

### خطأ 404 - Not Found
**السبب**: عدم تطابق اسم الجدول أو عدم وجود الجدول في قاعدة البيانات.

**الحلول**:
1. تأكد من أن اسم الجدول في الكود يطابق اسم الجدول في قاعدة البيانات
2. في هذا التطبيق، اسم الجدول هو `user_personal_data` وليس `personal_data`
3. تأكد من تنفيذ SQL Script في Supabase

### أخطاء PostgreSQL الشائعة

#### خطأ 23505 - Unique Violation
**الرسالة**: "لقد تم إرسال البيانات من قبل. لا يمكن إرسال البيانات أكثر من مرة واحدة."
**السبب**: محاولة إدراج بيانات مكررة لنفس المستخدم.
**الحل**: كل مستخدم يمكنه إرسال بياناته مرة واحدة فقط.

#### خطأ 23502 - Not Null Violation
**الرسالة**: "يرجى ملء جميع البيانات المطلوبة."
**السبب**: عدم إدخال قيمة لحقل مطلوب.
**الحل**: تأكد من ملء جميع الحقول المطلوبة.

#### خطأ 23514 - Check Constraint Violation
**الرسالة**: "بعض البيانات المدخلة غير صحيحة."
**السبب**: إدخال قيمة غير مسموحة في حقل له قيود.
**الحل**: تأكد من صحة القيم المدخلة.

## أخطاء المصادقة

### خطأ OTP منتهي الصلاحية
**الرسالة**: "رمز التحقق منتهي الصلاحية. يرجى طلب رمز جديد."
**السبب**: انتهاء مدة صلاحية رمز التحقق.
**الحل**: طلب رمز تحقق جديد.

### خطأ OTP غير صحيح
**الرسالة**: "رمز التحقق غير صحيح. يرجى التأكد من الرمز المدخل."
**السبب**: إدخال رمز تحقق خاطئ.
**الحل**: التأكد من الرمز المرسل إلى البريد الإلكتروني.

## أخطاء الشبكة

### عدم وجود اتصال بالإنترنت
**الرسالة**: "لا يوجد اتصال بالإنترنت. يرجى التأكد من الاتصال والمحاولة مرة أخرى."
**السبب**: عدم وجود اتصال بالإنترنت.
**الحل**: التأكد من الاتصال بالإنترنت.

### انتهاء مهلة الاتصال
**الرسالة**: "انتهت مهلة الاتصال. يرجى المحاولة مرة أخرى."
**السبب**: بطء الاتصال أو مشاكل في الخادم.
**الحل**: المحاولة مرة أخرى بعد قليل.

## خطوات التشخيص

1. **فحص رسالة الخطأ**: قراءة رسالة الخطأ باللغة العربية لفهم المشكلة
2. **فحص الاتصال**: التأكد من وجود اتصال بالإنترنت
3. **فحص البيانات**: التأكد من صحة البيانات المدخلة
4. **إعادة المحاولة**: المحاولة مرة أخرى بعد قليل

## أدوات التشخيص للمطورين

### فحص logs في VS Code
```bash
flutter logs
```

### فحص قاعدة البيانات في Supabase
1. الذهاب إلى Supabase Dashboard
2. فتح قسم Table Editor
3. التأكد من وجود الجداول المطلوبة
4. فحص البيانات المدرجة

### فحص API في Supabase
1. الذهاب إلى API section
2. فحص الـ RLS policies
3. التأكد من صحة الصلاحيات

## الإصلاحات المطبقة

### 1. تصحيح أسماء الجداول والأعمدة
- **الجدول**: `user_personal_data` بدلاً من `personal_data`
- **العمود**: `national_id_encrypted` بدلاً من `national_id`
- **العمود**: `compensation_type` بدلاً من `compensation_types`
- **العمود**: `rights_request_type` بدلاً من `rights_request_types`

### 2. تحسين معالجة الأخطاء
- إضافة رسائل خطأ واضحة باللغة العربية
- معالجة أخطاء PostgreSQL المختلفة
- معالجة أخطاء الشبكة والاتصال

### 3. تحسين التحقق من البيانات
- التحقق من البيانات المطلوبة قبل الإرسال
- تحويل أنواع البيانات بشكل صحيح
- التعامل مع القيم الفارغة

### 4. تحسين OTP
- تغيير نوع OTP من `magiclink` إلى `email`
- إضافة معالجة أفضل لأخطاء OTP
- رسائل خطأ أوضح

## صيغة قاعدة البيانات المحدثة

تم إنشاء ملف `create_tables_updated.sql` يحتوي على:
- البنية الصحيحة للجداول
- الفهارس للأداء
- سياسات الأمان (RLS)
- دوال التحديث التلقائي
- التعليقات التوضيحية
