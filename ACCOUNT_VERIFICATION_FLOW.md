# تحسين تدفق تأكيد الحساب

## الهدف
تحسين تدفق إنشاء الحساب لضمان أن المستخدم لا يمكنه الدخول للتطبيق بدون تأكيد بريده الإلكتروني أولاً.

## التحديثات المُطبقة

### 1. تحديث AuthProvider (auth_provider.dart)

#### إضافة Getters جديدة:
```dart
/// فحص ما إذا كان البريد الإلكتروني مؤكد
bool get isEmailConfirmed => _user?.emailConfirmedAt != null;

/// فحص ما إذا كان المستخدم مسجل الدخول ومؤكد البريد الإلكتروني
bool get isAuthenticatedAndConfirmed => isAuthenticated && isEmailConfirmed;
```

#### تحسين معالجة الأخطاء في signUp:
- إضافة معالجة خاصة لـ AuthApiException و AuthException
- ترجمة أفضل لرسائل الخطأ

### 2. تحديث RegisterScreen (register_screen.dart)

#### تغيير التوجيه بعد إنشاء الحساب:
```dart
// قبل: context.go(RouteNames.login);
// بعد: context.go(RouteNames.confirmAccount, extra: _emailController.text.trim());
```

الآن بعد إنشاء حساب جديد، يتم توجيه المستخدم مباشرة إلى صفحة تأكيد الحساب.

### 3. تحديث AppRouter (app_router.dart)

#### تحسين منطق Redirect:
```dart
// إذا كان المستخدم مسجل الدخول لكن غير مؤكد البريد الإلكتروني
if (isAuthenticated && !isEmailConfirmed) {
  // السماح بالوصول إلى صفحة تأكيد الحساب فقط
  if (state.matchedLocation != RouteNames.confirmAccount) {
    return RouteNames.confirmAccount;
  }
}
```

#### تحسين بناء صفحة تأكيد الحساب:
- يمكن الحصول على البريد الإلكتروني من `state.extra` أو من المستخدم الحالي
- هذا يسمح بالمرونة في التوجيه للصفحة

### 4. تحديث LoginScreen (login_screen.dart)

#### تحسين منطق تسجيل الدخول:
```dart
// التحقق من تأكيد البريد الإلكتروني حتى لو نجح تسجيل الدخول
if (authProvider.isEmailConfirmed) {
  context.go(RouteNames.home);
} else {
  // إذا لم يكن البريد الإلكتروني مؤكد، توجيه المستخدم إلى صفحة التأكيد
  context.go(RouteNames.confirmAccount, extra: _emailController.text.trim());
}
```

## التدفق الجديد

### 1. إنشاء حساب جديد:
1. المستخدم يملأ بيانات التسجيل
2. إنشاء الحساب في Supabase
3. إرسال بريد إلكتروني للتأكيد تلقائياً
4. **توجيه المستخدم مباشرة إلى صفحة تأكيد الحساب**

### 2. تسجيل الدخول:
1. المستخدم يدخل بيانات تسجيل الدخول
2. إذا نجح تسجيل الدخول:
   - **إذا كان البريد الإلكتروني مؤكد**: التوجه للصفحة الرئيسية
   - **إذا لم يكن البريد الإلكتروني مؤكد**: التوجه لصفحة التأكيد

### 3. الحماية على مستوى التطبيق:
- المستخدمون غير المؤكدين لا يمكنهم الوصول للصفحات المحمية
- يتم توجيههم تلقائياً لصفحة تأكيد الحساب
- لا يمكن تجاوز هذه المرحلة بأي طريقة

## الفوائد

1. **أمان أفضل**: ضمان تأكيد البريد الإلكتروني قبل الدخول
2. **تجربة مستخدم محسنة**: توجيه واضح ومباشر
3. **منع التجاوز**: لا يمكن للمستخدم الدخول بدون تأكيد
4. **مرونة**: يعمل مع جميع طرق تسجيل الدخول (كلمة مرور/OTP)

## المتطلبات من جانب الخادم (Supabase)

1. تأكد من تفعيل email confirmation في إعدادات Supabase
2. إعداد قالب البريد الإلكتروني المناسب
3. ضبط URL التأكيد إذا لزم الأمر

## الاختبار

للتأكد من صحة التطبيق:

1. إنشاء حساب جديد - يجب التوجه لصفحة التأكيد
2. تسجيل دخول بحساب غير مؤكد - يجب التوجه لصفحة التأكيد  
3. محاولة الوصول لصفحة محمية بحساب غير مؤكد - يجب منعها
4. تأكيد الحساب - يجب الوصول للصفحة الرئيسية
5. تسجيل دخول بحساب مؤكد - يجب الوصول للصفحة الرئيسية مباشرة
